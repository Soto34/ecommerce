{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Postventa</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet" />

  <!-- CSS Libraries -->
  <link rel="stylesheet" href="{% static 'assets/css/all.min.css' %}" />
  <link rel="stylesheet" href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}" />
  <link rel="stylesheet" href="{% static 'assets/css/main.css' %}" />
  <link rel="stylesheet" href="{% static 'assets/css/responsive.css' %}" />

  <style>
    .postventa-header {
      background-color: #2f414d;
      color: white;
      padding: 60px 0;
      text-align: center;
    }
    .postventa-header h1 {
      font-weight: 800;
      font-size: 2.5rem;
    }
    .postventa-header p {
      letter-spacing: 2px;
      color: #f9a825;
    }
    .postventa-box {
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 25px;
      margin-top: 30px;
      max-width: 1000px; /* por defecto puede estar limitado a menos, aumentamos */
      width: 100%; /* para que tome el ancho m치ximo posible dentro del contenedor padre */
      margin-left: auto;
      margin-right: auto; /* centra horizontalmente */
      box-sizing: border-box;
    }

    .btn-cobrar {
      font-size: 1.2rem;
      padding: 12px 30px;
      background-color: #4caf50;
      color: white;
      border: none;
    }
    .table td, .table th {
      vertical-align: middle;
    }
    .payment-summary {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-grow: 1;
    }
    .payment-summary .form-inline {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .payment-summary .form-inline input {
      width: 100px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="top-header-area" id="sticker" style="background-color: #051922;">
    <div class="container">
      <div class="row">
        <div class="col-lg-12 text-center">
          <div class="main-menu-wrap">
            <div class="site-logo">
              <a href="index_2.html"><img src="{% static 'assets/img/logo.png' %}" alt="" /></a>
            </div>
            <nav class="main-menu">
              <ul>
                <li><a href="#">Salir</a></li>
              </ul>
            </nav>
            <div class="mobile-menu"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- End Header -->

  <!-- Postventa Header -->
  <div class="postventa-header">
    <p>PANEL DEL CAJERO</p>
    <h1>Postventa</h1>
  </div>

  <div class="container">
    <div class="postventa-box shadow-sm">

      <!-- Mostrar mensaje de error -->
      {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
      {% endif %}

      <!-- Formulario para agregar producto por c칩digo -->
      <form method="post" action="{% url 'agregar_producto' ticket.id %}" class="d-flex justify-content-between align-items-center mb-4">
        {% csrf_token %}
        <input
          type="text"
          name="codigo_producto"
          class="form-control w-75"
          placeholder="C칩digo del producto"
          required
          autocomplete="off"
        />
        <button type="submit" class="btn btn-primary ml-3">ENTER</button>
      </form>

      <!-- Tabla del carrito -->
      <table class="table table-bordered text-center">
        <thead class="thead-light">
          <tr>
            <th>C칩digo</th>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for producto in productos %}
          <tr>
            <td>{{ producto.codigo }}</td>
            <td>{{ producto.nombre }}</td>
            <td>${{ producto.precio }}</td>
            <td>{{ producto.cantidad }}</td>
            <td>${{ producto.total }}</td>
            <td>
              <form method="post" action="{% url 'modificar_cantidad' ticket.id producto.id 'sumar' %}" style="display:inline;">
                {% csrf_token %}
                <button class="btn btn-success btn-sm">+</button>
              </form>
              <form method="post" action="{% url 'modificar_cantidad' ticket.id producto.id 'restar' %}" style="display:inline;">
                {% csrf_token %}
                <button class="btn btn-danger btn-sm">-</button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6">No hay productos en el carrito.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="d-flex justify-content-between align-items-center mt-4">
        <!-- Formulario para limpiar/eliminar ticket -->
        <form method="post" action="{% url 'limpiar_ticket' ticket.id %}" style="margin-right: 40px;">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger" style="min-width: 140px; padding-left: 20px; padding-right: 20px;">
            Limpiar Ticket
          </button>
        </form>

        <!-- Resumen y cobro -->
        <div class="payment-summary">
          <div class="form-inline">
            <label><strong>Total:</strong> ${{ total|floatformat:2 }}</label>
            {% if descuento > 0 %}
            <label><strong>Descuento (5%):</strong> -${{ descuento|floatformat:2 }}</label>
            <label><strong>Total a pagar:</strong> ${{ total_con_descuento|floatformat:2 }}</label>
            {% endif %}
            <p style="color: {{ color_mensaje }}; font-weight: bold; margin-left: 20px;">
              {{ mensaje_descuento }}
            </p>
            <label><strong>Paga con:</strong>
              <input type="number" class="form-control" placeholder="$0" id="pagaCon" />
            </label>
            <label><strong>Cambio:</strong> <span id="cambio-texto">$0</span></label>
          </div>
        </div>

        <!-- Formulario para cobrar -->
        <form method="post" action="{% url 'cobrar_ticket' ticket.id %}">
          {% csrf_token %}
          <button type="submit" class="btn-cobrar">COBRAR</button>
        </form>
      </div>
    </div>
  </div>

  <!-- JS Scripts -->
  <script src="{% static 'assets/js/jquery-1.11.3.min.js' %}"></script>
  <script src="{% static 'assets/bootstrap/js/bootstrap.min.js' %}"></script>
  <script src="{% static 'assets/js/main.js' %}"></script>

  <!-- Script para calcular cambio -->
  <script>
  const pagaConInput = document.getElementById('pagaCon');
  const cambioTexto = document.getElementById('cambio-texto');
  // Usamos total con descuento si existe, sino total
  const total = parseFloat("{{ total_con_descuento|default:total|floatformat:2 }}");

  pagaConInput.addEventListener('input', () => {
    const pagaCon = parseFloat(pagaConInput.value) || 0;
    const cambio = pagaCon - total;
    cambioTexto.textContent = '$' + (cambio > 0 ? cambio.toFixed(2) : '0');
  });
  </script>
</body>
</html>
